function getCookie(t,e){var i=document.cookie.match(new RegExp("(?:^|; )"+t.replace(/([\.$?*|{}\(\)\[\]\\\/\+^])/g,"\\$1")+"=([^;]*)"));return i?decodeURIComponent(i[1]):e}function setCookie(t,e){e=encodeURIComponent(e);var i=t+"="+e,o=new Date,n=o.setDate(o.getDate()+365);i+="; expires="+n,document.cookie=i}function setCookies(t){for(var e in t)console.log(e.value)}function getState(t,e){var i=(location.search.split(t+"=")[1]||"").split("&",1)[0];return i?i:getCookie(t,e)}function setState(t){var e=t.getCenter().lat,i=t.getCenter().lng,o=t.getZoom(),t=window.globalMapLayer;return setCookie("lat",e),setCookie("lon",i),setCookie("zoom",o),setCookie("map",t),"?lat"+e+"&lon="+i+"&zoom="+o+"&map="+t}function showOverlayLayers(t){var e=t.split("@@"),i={},o="",n="";if($.isArray(e))for(var a=e.length;a--;){var s=e[a].split("##",2);void 0!==s[1]?(o=$.isNumeric(s[0])?timeConverter(s[0]):s[0],n=s[1]):(o="Трек "+a,n=s[0]),i[o]=new L.GPX(n,{async:!0})}else(""!=e||"undefined"!=e)&&(i["Трек 1"]=e);return i}function timeConverter(t){var e=new Date(1e3*t),i=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],o=e.getFullYear(),n=i[e.getMonth()],a=e.getDate(),s=e.getHours(),r=e.getMinutes(),l=e.getSeconds(),p=a+" "+n+" "+o+" "+s+":"+r+":"+l;return p}L.BingLayer=L.TileLayer.extend({options:{subdomains:[0,1,2,3],type:"Aerial",attribution:"Bing",culture:""},initialize:function(t,e){L.Util.setOptions(this,e),this._key=t,this._url=null,this._providers=[],this.metaRequested=!1},tile2quad:function(t,e,i){for(var o="",n=i;n>0;n--){var a=0,s=1<<n-1;0!==(t&s)&&(a+=1),0!==(e&s)&&(a+=2),o+=a}return o},getTileUrl:function(t){var e=this._getZoomForUrl(),i=this.options.subdomains,o=this.options.subdomains[Math.abs((t.x+t.y)%i.length)];return this._url.replace("{subdomain}",o).replace("{quadkey}",this.tile2quad(t.x,t.y,e)).replace("{culture}",this.options.culture)},loadMetadata:function(){if(!this.metaRequested){this.metaRequested=!0;var t=this,e="_bing_metadata_"+L.Util.stamp(this);window[e]=function(i){window[e]=void 0;var o=document.getElementById(e);if(o.parentNode.removeChild(o),i.errorDetails)throw new Error(i.errorDetails);t.initMetadata(i)};var i="file:"===document.location.protocol?"http":document.location.protocol.slice(0,-1),o=i+"://dev.virtualearth.net/REST/v1/Imagery/Metadata/"+this.options.type+"?include=ImageryProviders&jsonp="+e+"&key="+this._key+"&UriScheme="+i,n=document.createElement("script");n.type="text/javascript",n.src=o,n.id=e,document.getElementsByTagName("head")[0].appendChild(n)}},initMetadata:function(t){var e=t.resourceSets[0].resources[0];if(this.options.subdomains=e.imageUrlSubdomains,this._url=e.imageUrl,e.imageryProviders)for(var i=0;i<e.imageryProviders.length;i++)for(var o=e.imageryProviders[i],n=0;n<o.coverageAreas.length;n++){var a=o.coverageAreas[n],s={zoomMin:a.zoomMin,zoomMax:a.zoomMax,active:!1},r=new L.LatLngBounds(new L.LatLng(a.bbox[0]+.01,a.bbox[1]+.01),new L.LatLng(a.bbox[2]-.01,a.bbox[3]-.01));s.bounds=r,s.attrib=o.attribution,this._providers.push(s)}this._update()},_update:function(){null!==this._url&&this._map&&(this._update_attribution(),L.TileLayer.prototype._update.apply(this,[]))},_update_attribution:function(){for(var t=this._map.getBounds(),e=this._map.getZoom(),i=0;i<this._providers.length;i++){var o=this._providers[i];e<=o.zoomMax&&e>=o.zoomMin&&t.intersects(o.bounds)?(!o.active&&this._map.attributionControl&&this._map.attributionControl.addAttribution(o.attrib),o.active=!0):(o.active&&this._map.attributionControl&&this._map.attributionControl.removeAttribution(o.attrib),o.active=!1)}},onAdd:function(t){this.loadMetadata(),L.TileLayer.prototype.onAdd.apply(this,[t])},onRemove:function(t){for(var e=0;e<this._providers.length;e++){var i=this._providers[e];i.active&&this._map.attributionControl&&(this._map.attributionControl.removeAttribution(i.attrib),i.active=!1)}L.TileLayer.prototype.onRemove.apply(this,[t])}}),L.bingLayer=function(t,e){return new L.BingLayer(t,e)},L.Google=L.Class.extend({includes:L.Mixin.Events,options:{minZoom:0,maxZoom:18,tileSize:256,subdomains:"abc",errorTileUrl:"",attribution:"",opacity:1,continuousWorld:!1,noWrap:!1,mapOptions:{backgroundColor:"#dddddd"}},initialize:function(t,e){L.Util.setOptions(this,e),this._ready=void 0!==google.maps.Map,this._ready||L.Google.asyncWait.push(this),this._type=t||"SATELLITE"},onAdd:function(t,e){this._map=t,this._insertAtTheBottom=e,this._initContainer(),this._initMapObject(),t.on("viewreset",this._reset,this),this._limitedUpdate=L.Util.limitExecByInterval(this._update,150,this),t.on("move",this._update,this),t.on("zoomanim",this._handleZoomAnim,this),t._controlCorners.bottomright.style.marginBottom="20px",this._reset(),this._update()},onRemove:function(t){t._container.removeChild(this._container),t.off("viewreset",this._reset,this),t.off("move",this._update,this),t.off("zoomanim",this._handleZoomAnim,this),t._controlCorners.bottomright.style.marginBottom="0em"},getAttribution:function(){return this.options.attribution},setOpacity:function(t){this.options.opacity=t,1>t&&L.DomUtil.setOpacity(this._container,t)},setElementSize:function(t,e){t.style.width=e.x+"px",t.style.height=e.y+"px"},_initContainer:function(){var t=this._map._container,e=t.firstChild;this._container||(this._container=L.DomUtil.create("div","leaflet-google-layer leaflet-top leaflet-left"),this._container.id="_GMapContainer_"+L.Util.stamp(this),this._container.style.zIndex="auto"),t.insertBefore(this._container,e),this.setOpacity(this.options.opacity),this.setElementSize(this._container,this._map.getSize())},_initMapObject:function(){if(this._ready){this._google_center=new google.maps.LatLng(0,0);var t=new google.maps.Map(this._container,{center:this._google_center,zoom:0,tilt:0,mapTypeId:google.maps.MapTypeId[this._type],disableDefaultUI:!0,keyboardShortcuts:!1,draggable:!1,disableDoubleClickZoom:!0,scrollwheel:!1,streetViewControl:!1,styles:this.options.mapOptions.styles,backgroundColor:this.options.mapOptions.backgroundColor}),e=this;this._reposition=google.maps.event.addListenerOnce(t,"center_changed",function(){e.onReposition()}),this._google=t,google.maps.event.addListenerOnce(t,"idle",function(){e._checkZoomLevels()}),google.maps.event.addListenerOnce(t,"tilesloaded",function(){e.fire("load")}),this.fire("MapObjectInitialized",{mapObject:t})}},_checkZoomLevels:function(){void 0!==this._map.getZoom()&&this._google.getZoom()!==this._map.getZoom()&&this._map.setZoom(this._google.getZoom())},_reset:function(){this._initContainer()},_update:function(){if(this._google){this._resize();var t=this._map.getCenter(),e=new google.maps.LatLng(t.lat,t.lng);this._google.setCenter(e),void 0!==this._map.getZoom()&&this._google.setZoom(Math.round(this._map.getZoom())),this._checkZoomLevels()}},_resize:function(){var t=this._map.getSize();(this._container.style.width!==t.x||this._container.style.height!==t.y)&&(this.setElementSize(this._container,t),this.onReposition())},_handleZoomAnim:function(t){var e=t.center,i=new google.maps.LatLng(e.lat,e.lng);this._google.setCenter(i),this._google.setZoom(Math.round(t.zoom))},onReposition:function(){this._google&&google.maps.event.trigger(this._google,"resize")}}),L.Google.asyncWait=[],L.Google.asyncInitialize=function(){var t;for(t=0;t<L.Google.asyncWait.length;t++){var e=L.Google.asyncWait[t];e._ready=!0,e._container&&(e._initMapObject(),e._update())}L.Google.asyncWait=[]},L.Yandex=L.Class.extend({includes:L.Mixin.Events,options:{minZoom:0,maxZoom:18,attribution:"",opacity:1,traffic:!1},possibleShortMapTypes:{schemaMap:"map",satelliteMap:"satellite",hybridMap:"hybrid",publicMap:"publicMap",publicMapInHybridView:"publicMapHybrid"},_getPossibleMapType:function(t){var e="yandex#map";if("string"!=typeof t)return e;for(var i in this.possibleShortMapTypes){if(t===this.possibleShortMapTypes[i]){e="yandex#"+t;break}t==="yandex#"+this.possibleShortMapTypes[i]&&(e=t)}return e},initialize:function(t,e){L.Util.setOptions(this,e),this._type=this._getPossibleMapType(t)},onAdd:function(t,e){this._map=t,this._insertAtTheBottom=e,this._initContainer(),this._initMapObject(),t.on("viewreset",this._reset,this),this._limitedUpdate=L.Util.limitExecByInterval(this._update,150,this),t.on("move",this._update,this),t._controlCorners.bottomright.style.marginBottom="3em",this._reset(),this._update(!0)},onRemove:function(t){this._map._container.removeChild(this._container),this._map.off("viewreset",this._reset,this),this._map.off("move",this._update,this),t._controlCorners.bottomright.style.marginBottom="0em"},getAttribution:function(){return this.options.attribution},setOpacity:function(t){this.options.opacity=t,1>t&&L.DomUtil.setOpacity(this._container,t)},setElementSize:function(t,e){t.style.width=e.x+"px",t.style.height=e.y+"px"},_initContainer:function(){var t=this._map._container,e=t.firstChild;this._container||(this._container=L.DomUtil.create("div","leaflet-yandex-layer leaflet-top leaflet-left"),this._container.id="_YMapContainer_"+L.Util.stamp(this),this._container.style.zIndex="auto"),this.options.overlay&&(e=this._map._container.getElementsByClassName("leaflet-map-pane")[0],e=e.nextSibling,L.Browser.opera&&(this._container.className+=" leaflet-objects-pane")),t.insertBefore(this._container,e),this.setOpacity(this.options.opacity),this.setElementSize(this._container,this._map.getSize())},_initMapObject:function(){if(!this._yandex){if(void 0===ymaps.Map)return ymaps.load(["package.map"],this._initMapObject,this);if(this.options.traffic&&(void 0===ymaps.control||void 0===ymaps.control.TrafficControl))return ymaps.load(["package.traffic","package.controls"],this._initMapObject,this);var t=new ymaps.Map(this._container,{center:[0,0],zoom:0,behaviors:[],controls:[]});this.options.traffic&&t.controls.add(new ymaps.control.TrafficControl({shown:!0})),"yandex#null"===this._type&&(this._type=new ymaps.MapType("null",[]),t.container.getElement().style.background="transparent"),t.setType(this._type),this._yandex=t,this._update(!0),this.fire("MapObjectInitialized",{mapObject:t})}},_reset:function(){this._initContainer()},_update:function(t){if(this._yandex){this._resize(t);var e=this._map.getCenter(),i=[e.lat,e.lng],o=this._map.getZoom();(t||this._yandex.getZoom()!==o)&&this._yandex.setZoom(o),this._yandex.panTo(i,{duration:0,delay:0})}},_resize:function(t){var e=this._map.getSize(),i=this._container.style;(i.width!==e.x+"px"||i.height!==e.y+"px"||t===!0)&&(this.setElementSize(this._container,e),this._yandex.container.fitToViewport())}}),L.GPX=L.FeatureGroup.extend({initialize:function(t,e){L.Util.setOptions(this,e),this._gpx=t,this._layers={},t&&this.addGPX(t,e,this.options.async)},loadXML:function(t,e,i,o){void 0===o&&(o=this.options.async),void 0===i&&(i=this.options);var n=new window.XMLHttpRequest;n.open("GET",t,o);try{n.overrideMimeType("text/xml")}catch(a){}n.onreadystatechange=function(){4===n.readyState&&200===n.status&&e(n.responseXML,i)},n.send(null)},_humanLen:function(t){return 2e3>t?t.toFixed(0)+" m":(t/1e3).toFixed(1)+" km"},_polylineLen:function(t){for(var e=t._latlngs,i=0,o=null,n=0;n<e.length;n++)n&&o&&(i+=o.distanceTo(e[n])),o=e[n];return i},addGPX:function(t,e,i){var o=this,n=function(t,e){o._addGPX(t,e)};this.loadXML(t,n,e,i)},_addGPX:function(t,e){var i=this.parseGPX(t,e);i&&(this.addLayer(i),this.fire("loaded"))},parseGPX:function(t,e){var i,o,n,a=[],s=!1,r=[["rte","rtept"],["trkseg","trkpt"]];for(i=0;i<r.length;i++)for(n=t.getElementsByTagName(r[i][0]),o=0;o<n.length;o++)for(var l=this.parse_trkseg(n[o],t,e,r[i][1]),p=0;p<l.length;p++)this.parse_name(n[o],l[p])&&(s=!0),a.push(l[p]);if(n=t.getElementsByTagName("wpt"),e.display_wpt!==!1)for(o=0;o<n.length;o++){var h=this.parse_wpt(n[o],t,e);h&&(this.parse_name(n[o],h)&&(s=!0),a.push(h))}if(a.length){var d=a[0];return a.length>1&&(d=new L.FeatureGroup(a)),s||this.parse_name(t,d),d}},parse_name:function(t,e){var i,o,n,a="",s="",r=0;for(o=t.getElementsByTagName("name"),o.length&&(n=o[0].childNodes[0].nodeValue),o=t.getElementsByTagName("desc"),i=0;i<o.length;i++)for(var l=0;l<o[i].childNodes.length;l++)s+=o[i].childNodes[l].nodeValue;return e instanceof L.Path&&(r=this._polylineLen(e)),n&&(a+="<h2>"+n+"</h2>"+s),r&&(a+="<p>"+this._humanLen(r)+"</p>"),e&&void 0===e._popup&&e.bindPopup(a),a},parse_trkseg:function(t,e,i,o){var n=t.getElementsByTagName(o);if(!n.length)return[];for(var a=[],s=0;s<n.length;s++){var r=new L.LatLng(n[s].getAttribute("lat"),n[s].getAttribute("lon"));r.meta={};for(var l in n[s].childNodes){var p=n[s].childNodes[l];p.tagName&&(r.meta[p.tagName]=p.textContent)}a.push(r)}var h=[new L.Polyline(a,i)];return this.fire("addline",{line:h}),h},parse_wpt:function(t,e,i){for(var o=new L.Marker(new L.LatLng(t.getAttribute("lat"),t.getAttribute("lon")),i),n={},a=0;a<t.childNodes.length;a++){var s=t.childNodes[a];"#text"!==s.nodeName&&(n[s.nodeName]=s.textContent)}return this.fire("addpoint",{point:o,attributes:n}),o}}),$(document).ready(function(){var t=L.map("map",{zoomControl:!1}),e=getState("lat",56.013358),i=getState("lon",92.852202),o=getState("zoom",15);window.globalMapLayer=getState("map","osm");var n='Map data <a target="_blank" href="http://www.openstreetmap.org">OpenStreetMap.org</a>; contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>';t.setView([e,i],o);var a=L.tileLayer("http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"sibreg.org &copy; "+n,maxZoom:18});t.on("dragend",function(e){history.replaceState({},null,setState(t))}),t.on("zoomend",function(e){history.replaceState({},"",setState(t))}),t.on("baselayerchange",function(e){window.globalMapLayer=e.name.split("#",2)[1],history.replaceState({},"",setState(t))});var s=new L.Yandex("satellite"),r=new L.Google("SATELLITE"),l=L.tileLayer("http://tile{s}.maps.2gis.ru/tiles?v=1112&x={x}&y={y}&z={z}",{subdomains:["1","2","3","4"],format:"image/png",maxZoom:18}),p=new L.BingLayer("LfO3DMI9S6GnXD7d0WGs~bq2DRVkmIAzSOFdodzZLvw~Arx8dclDxmZA0Y38tHIJlJfnMbGq5GXeYmrGOUIbS2VLFzRKCK0Yv_bAl6oe-DOc",{type:"Aerial"}),h={'<span data-name="#osm#">OpenStreetMap</span>':a,'<span data-name="#yandex#">Яндекс</span>':s,'<span data-name="#google#">Google</span>':r,'<span data-name="#bing#">Bing</span>':p,'<span data-name="#doublegis#">Дубль ГИС</span>':l};switch(window.globalMapLayer){case"yandex":t.addLayer(s);break;case"google":t.addLayer(r);break;case"bing":t.addLayer(p);break;case"doublegis":t.addLayer(l);break;default:t.addLayer(a)}var d=$("#inpLastTrack").val();(""!=d||"undefined"!=d)&&new L.GPX(d,{async:!0}).on("loaded",function(e){t.fitBounds(e.target.getBounds())}).addTo(t);var c=$("#inpTracks").val(),m={};(""!=c||"undefined"!=c)&&(m=showOverlayLayers(c)),t.addControl(new L.Control.Layers(h,m)),t.addControl(new L.Control.Zoom({position:"topright"}))});